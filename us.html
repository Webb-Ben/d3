<!DOCTYPE html>
<meta charset="utf-8">
<style>

.border {
  fill: none;
  stroke: #FFF;
  stroke-width: 0.5;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.county {
  fill: none;
  opacity: 0.7;
}

.state {
  fill: #001933;
  opacity: 0.3;
  cursor: crosshair;
}

</style>
<body>
    <script src = "https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo.v2.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
<script>
    const width = 1200,
          height = 750;

    const path = d3.geoPath()
                   .projection(null);
        
    const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", zoomed);

    const svg = d3.select("body")
         .append("svg")
         .attr("viewBox", [0, 0, width, height])
         .on("click", reset);
    
    var g = svg.append("g");
    var mask = svg.append("g");
    var transition = d3.transition();
    var centered = null;
                
    d3.json("us.json", function(error, us) {
    if (error) return console.error(error);
    
    d3.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/live/us-counties.csv", function(error, data){
           var covid_data = {};
           var range = [];
           var max_cases = 0;
           var min_cases = 0;
           if (error) return console.error(error);
           
           data.forEach(function(d) {
                    covid_data[+d.fips] = +d.cases;
                    range.push(+d.cases);
           });
           
           var color = d3.scaleQuantize()
           .domain(range)
           .range(["#0A2F51", "#0E4D64", "#137177", "#188977", "#1D9A6C", "#39A96B", "#74C67A", "#99D492", "#BFE1B0", "#DEEDCF"]);
            
           const counties = g.append("g")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.counties).features)
            .enter()
            .append("path")
            .on("mouseover", formTooltip)
            .on("mouseout", endTooltip)
            .style("fill", function(d) {
                 return color(covid_data[+d.id]);
             })
            .attr("class", "county")
            .attr("d", path);
           
           g.append("path")
           .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
           .attr("class", "border border--state")
           .attr("d", path);
    });
    
    mask.append("g")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.states).features)
    .enter()
    .append("path")
    .on("mouseover", onMouseOver)
    .on("mouseout", onMouseOut)
    .on("click", clicked)
    .attr("class", "state")
    .attr("d", path);
    });

    
    function onMouseOver(event, d) {
        d3.select(this).style("opacity", 0.5);
    };

    function onMouseOut(event, d) {
        d3.select(this).style("opacity", 0.3);
    };

function formTooltip(event, d) {
    d3.select(this).style("opacity", 0.1);
};

function endTooltip(event, d) {
    d3.select(this).style("opacity", 0.7);
};


    function clicked(d) {
        console.log('hi1');
      var x0, y0, x1, y1, k;
      if (centered != d){
        [[x0, y0], [x1, y1]] = path.bounds(d);
        k = Math.min(8, 0.7 / Math.max((x1 - x0) / width, (y1 - y0) / height));
        centered = d;
        mask.remove();
        g
         .transition()
         .duration(750)
         .attr('transform',
               'translate('+width/2 +','+height/2+')scale('+k+')translate('+-(x0+x1)/2+','+-(y0+y1)/2+')');
      } else {
        centered = null;
        reset();
      }
                    
    mask.remove();
    g
     .transition()
     .duration(750)
     .attr('transform',
           'translate('+width/2 +','+height/2+')scale('+k+')translate('+-(x0+x1)/2+','+-(y0+y1)/2+')');
    };
                 
    function reset() {
                     console.log('hi');
      g.transition()
       .duration(750)
       .attr('transform',
             'translate('+width/2 +','+height/2+')scale('+1+')translate('+-width/2+','+-height/2+')');
    }
  
</script>
