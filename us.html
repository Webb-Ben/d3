<!DOCTYPE html>
<meta charset="utf-8">
<style>

.border {
  fill: none;
  stroke: #FFF;
  stroke-width: 0.2;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.state {
  fill: #001933;
  opacity: 0.5;
  background-color: #F00;
  cursor: crosshair;
}

.state {
  fill: null;
  cursor: crosshair;
}

</style>
<body>
    <script type = "text/javascript" src = "https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo.v2.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    
<script>
    
    const width = 1200,
          height = 750;

    const path = d3.geoPath()
        .projection(null);
        
    const zoom = d3.zoom()
        .on("zoom", zoomed);

    const svg = d3.select("body")
         .append("svg")
         .attr("viewBox", [0, 0, width, height])
         .on("click", reset);
    
    var g = svg.append("g");
    
    var transition = d3.transition();
    
    var centered = null;
                
    d3.json("us.json", function(error, us) {
    if (error) return console.error(error);
    const states = g.append("g")
          .selectAll("path")
          .data(topojson.feature(us, us.objects.states).features)
          .enter()
          .append("path")
          .on("mouseover", onMouseOver)
          .on("mouseout", onMouseOut)
          .on("click", clicked)
          .attr("class", "state")
          .attr("d", path);
    
    d3.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/live/us-counties.csv", function(error, data){
           const counties = topojson.feature(us, us.objects.counties).features;
           var covid_data = {};
           var range = [];
           var max_cases = 0;
           var min_cases = 0;
           if (error) return console.error(error);
                data.forEach(function(d) {
                    covid_data[+d.fips] = +d.confirmed_cases;
                    range.push(+d.confirmed_cases);
           });
           
           var color = d3.scaleQuantize()
           .domain(range)
           .range(["#0A2F51", "#0E4D64", "#137177", "#188977", "#1D9A6C", "#39A96B", "#74C67A", "#99D492", "#BFE1B0", "#DEEDCF"]);
        
            svg.append("g")
            .attr("class", "counties")
            .selectAll("path")
            .data(topojson.feature(us, us.objects.counties).features)
            .enter()
            .append("path")
            .attr("d", path)
            .style("fill", function(d) {
                 return color(covid_data[d.id]);
             })
           .style("opactiy", 0.1);

    });
    
        
    states.append("title")
            .text(d => d.properties.name);
    
    g.append("path")
          .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b; }))
          .attr("class", "border border--county")
          .attr("d", path);
    
    g.append("path")
            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
            .attr("class", "border border--state")
            .attr("d", path);
    });

    
    function onMouseOver(event, d) {
        d3.select(this).style("opacity", 0.65);
    };

    function onMouseOut(event, d) {
        d3.select(this).style("opacity", 0.5);
    };

    function clicked(d) {
      var x0, y0, x1, y1, k;
      if (centered != d){
        [[x0, y0], [x1, y1]] = path.bounds(d);
        k = Math.min(8, 0.8 / Math.max((x1 - x0) / width, (y1 - y0) / height));
        centered = d;
      } else {
        [[x0, y0], [x1, y1]] = [[0, 0], [width, height]];
        k = 1;
        centered = null;
      }
      d3.selectAll('.state').style("fill", "#001933");
      d3.select(this).style("fill", "#f00");
      g.transition()
       .duration(750)
       .attr('transform',
             'translate(' + width/2 + ',' +  height / 2 + ')scale(' + k + ')translate(' + -(x0+x1)/2 + ',' + -(y0+y1)/2 + ')');
    };
                 
    function reset() {
      d3.selectAll(".state").attr("class", "state");
    }
                 
                 function zoomed(event) {
                   const {transform} = event;
                   g.attr("transform", transform);
                   g.attr("stroke-width", 1 / transform.k);
                 }
  

    
</script>
